@model IEnumerable<MrGroom_KY_SL.Models.Customer>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Admin - Customers";
    bool isManageMode = Request.QueryString["manage"] == "true";
    <link href="~/Content/custom-styles.css" rel="stylesheet" />;
}

<!-- PAGE HEADER -->
<div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-2">
        <div class="page-header-icon">
            <i class="fas fa-users"></i>
        </div>
        <h3 class="page-title mb-0">Customers</h3>
    </div>
</div>

<hr class="soft-gradient-line" />

<!-- SUMMARY CARDS -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="icon-circle bg-primary text-white me-3">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Total Customers</h6>
                    <h3 class="mb-0 fw-bold">@Model.Count()</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="icon-circle bg-success text-white me-3">
                    <i class="fas fa-envelope"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">With Email</h6>
                    <h3 class="mb-0 fw-bold">@Model.Count(c => !string.IsNullOrEmpty(c.Email))</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="icon-circle bg-info text-white me-3">
                    <i class="fas fa-phone"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">With Phone</h6>
                    <h3 class="mb-0 fw-bold">@Model.Count(c => !string.IsNullOrEmpty(c.Phone))</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="icon-circle bg-warning text-dark me-3">
                    <i class="fas fa-city"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Unique Cities</h6>
                    <h3 class="mb-0 fw-bold">@Model.SelectMany(c => c.Addresses).Where(a => a.City != null).Select(a => a.City).Distinct().Count()</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="soft-gradient-line" />

<!-- SEARCH + CREATE -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    @using (Html.BeginForm("Index", "Customer", FormMethod.Get))
    {
        <div class="search-bar-soft d-flex align-items-center">
            <input type="text" name="searchTerm" placeholder="Search..." value="@ViewBag.SearchTerm" />
            <button type="submit"><i class="fas fa-search"></i></button>
        </div>
    }

    @if (User.IsInRole("Admin"))
    {
        <a href="@Url.Action("Create", "Customer")" class="fab-btn-inline">
            <i class="fas fa-plus"></i>
            <span class="ms-2">Add Customer</span>
        </a>
    }
</div>

<hr class="soft-gradient-line" />

<!-- TABLE + PAGINATION -->
<div id="customersContainer">
    @Html.Partial("_CustomersTable", Model)
</div>

@section Scripts {
    <script>
        $(document).on("click", ".ajax-page", function (e) {
            e.preventDefault();
            var url = $(this).attr("href");

            $.ajax({
                url: url,
                type: "GET",
                dataType: "html",
                beforeSend: function () {
                    $("#customersContainer").css("opacity", "0.6");
                },
                success: function (data) {
                    if ($(data).find("#customersContainer").length) {
                        $("#customersContainer").html($(data).find("#customersContainer").html());
                    } else {
                        $("#customersContainer").html(data);
                    }
                    $("#customersContainer").css("opacity", "1");
                    $('[data-bs-toggle="tooltip"]').tooltip();
                },
                error: function () {
                    alert("Failed to load data. Please try again.");
                    $("#customersContainer").css("opacity", "1");
                }
            });
        });
    </script>
}
